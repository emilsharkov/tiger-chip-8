<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CHIP-8 Emulator</title>
</head>
<body>
  <h1>Hello, CHIP-8</h1>
  <canvas id="canvas"></canvas>
  <audio id="audio"></audio>
  <input type="file" id="rom" />
  <script type="module">
    import init, {
      get_canvas_context,
      get_audio,
      get_width,
      get_height,
      WasmEmulator
    } from "../wasm/pkg/tiger_chip_8_wasm.js";
    await init();

    let keyupHandler;
    let keydownHandler;

    async function setupEmulator(romBytes) {
      const width = get_width();
      const height = get_height();
      const scale = 10;
      const opPerFrame = 10;

      const ctx = get_canvas_context(width, height, scale);
      const audio = get_audio();
    
      let emulator = new WasmEmulator(ctx, audio);
      emulator.load_font_set();
      emulator.load_rom(romBytes);
    
      if (keydownHandler) document.removeEventListener("keydown", keydownHandler);
      if (keyupHandler) document.removeEventListener("keyup", keyupHandler);
    
      keydownHandler = (event) => {
        const keycode = emulator.to_keycode(event.key);
        emulator.handle_key_press(keycode, true);
      };
      keyupHandler = (event) => {
        const keycode = emulator.to_keycode(event.key);
        emulator.handle_key_press(keycode, false);
      };
    
      document.addEventListener("keydown", keydownHandler);
      document.addEventListener("keyup", keyupHandler);
    
      function renderFrame() {
        for (let i = 0; i < opPerFrame; i++) {
          emulator.emulate_instruction();
        }
        emulator.tick_timers();
        emulator.draw_screen(width, scale);
        requestAnimationFrame(renderFrame);
      }
    
      renderFrame();
    }

    document.getElementById("rom").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      const romBytes = new Uint8Array(arrayBuffer);
      setupEmulator(romBytes);
    });
  </script>
</body>
</html>
